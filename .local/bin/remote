#!/bin/sh
#
# Manage remotes
# TODO ssh key management

help() {
    echo "Usage: remote OPTION USERNAME

Options:
-s: ssh -- shell
-f: sftp -- file transfer
-m: sshfs -- mount remote
-u: fusermount3 -u -- umount remote" && exit
    }

umount() {
	[ "$1" = "-u" ] && [ -f $mount_point ]  ||  fusermount3 -u $mount_point && unlink $HOME/mnt && echo "Remote unmounted" || echo "Nothing mounted on $mount_point" ; exit
}

mount_point=$XDG_DATA_HOME/mnt
usernames_path=$HOME/.ssh/usernames

[ -z ${1+x} ] && help

[ "$1" = "-u" ] && umount

[ -z ${2+x} ] && [ -f $usernames_path ] && username=$(cat $usernames_path | fzf) || username=$2
[ -z $username ] && help

host=$(cat $HOME/.ssh/known_hosts | tr "," "\n" | tr -d "[" | cut -d" " -f1 | fzf)

case $1 in
    -s)         ssh $username@$host ;;
    -f)         sftp $username@$host ;;
    -m)         sshfs $username@$host:/ $mount_point && ln -s $mount_point $HOME/mnt && echo "Remote successfully mounted at $HOME/mnt" ;;
    *)          help ;;
esac
